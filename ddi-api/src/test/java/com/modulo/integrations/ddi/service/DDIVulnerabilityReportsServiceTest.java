package com.modulo.integrations.ddi.service;

import java.io.BufferedReader;
import java.io.FileReader;
import java.io.IOException;
import java.security.NoSuchAlgorithmException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.jmock.Expectations;
import org.jmock.Mockery;
import org.jmock.lib.legacy.ClassImposteriser;
import org.junit.Before;
import org.junit.Test;

import com.modulo.integrations.ddi.adapter.DDIVulnerabilityReportsServiceAdapter;
import com.modulo.integrations.ddi.to.VulnerabilityReport;
import com.modulo.integrations.ddi.utils.DDIReportListUtil;

import static org.junit.Assert.assertFalse;

public class DDIVulnerabilityReportsServiceTest {

   private Mockery context;

   @Before
   public void init() {

      this.context = new Mockery() {

         {

            this.setImposteriser(ClassImposteriser.INSTANCE);

         }

      };
   }

   @Test
   public void deveProcessarRelatorioQuandoListaValida() throws IOException, NoSuchAlgorithmException {

      final DDIVulnerabilityReportsServiceAdapter serviceAdapterMock = this.context.mock(DDIVulnerabilityReportsServiceAdapter.class);

      final DDIReportListUtil ddiReportListUtilMock = this.context.mock(DDIReportListUtil.class);

      final Map<String, StringBuffer> reports = new HashMap<String, StringBuffer>();

      reports.put("ExportTest.xml", this.getBuffer());

      this.context.checking(new Expectations() {

         {

            this.one(serviceAdapterMock).list();
            this.will(returnValue(reports));

            this.one(ddiReportListUtilMock).isNotProcessed(this.with(any(String.class)));
            this.will(returnValue(Boolean.TRUE));

            this.one(ddiReportListUtilMock).register(this.with(any(String.class)));

         }

      });

      final DDIVulnerabilityReportsService reportsService = new DDIVulnerabilityReportsService();

      reportsService.setServiceAdapter(serviceAdapterMock);

      reportsService.setReportListUtilMock(ddiReportListUtilMock);

      final List<VulnerabilityReport> actual = reportsService.list();

      assertFalse(actual.isEmpty());

      assertFalse(actual.iterator().next().getHosts().isEmpty());

      this.context.assertIsSatisfied();

   }

   private StringBuffer getBuffer() throws IOException {

      final BufferedReader reader = new BufferedReader(new FileReader("src/test/resources/stubs/Module Export Test Jan 21 2015 - portless ports excluded.xml"));

      final StringBuffer buffer = new StringBuffer();

      while (reader.ready()) {

         buffer.append(reader.readLine().trim());
      }

      reader.close();

      return buffer;

   }
}
